<view class="container">
  <!-- Tab Bar -->
  <view class="tab-bar flex-row">
    <view class="tab-item {{currentTab === index ? 'active' : ''}}" 
          wx:for="{{tabs}}" wx:key="*this"
          bindtap="switchTab" data-index="{{index}}">
      {{item}}
      <view class="tab-line" wx:if="{{currentTab === index}}"></view>
    </view>
  </view>

  <!-- Calendar View -->
  <view class="calendar-card card mb-20">
    <!-- Month Switcher -->
    <view class="calendar-header flex-row justify-between align-center mb-20">
        <view class="month-btn" bindtap="prevMonth">◀</view>
        <text class="text-h3">{{currentYear}}年{{currentMonth}}月</text>
        <view class="month-btn" bindtap="nextMonth">▶</view>
    </view>
    
    <!-- Week Header -->
    <view class="week-header flex-row justify-between mb-10">
        <text class="week-item" wx:for="{{['日','一','二','三','四','五','六']}}" wx:key="*this">{{item}}</text>
    </view>

    <!-- Days Grid -->
    <view class="days-grid">
        <view class="day-item {{item.isCurrentMonth ? '' : 'other-month'}} {{item.dateString === selectedDate ? 'selected' : ''}}" 
              wx:for="{{calendarDays}}" wx:key="dateString"
              bindtap="onDateSelect" data-date="{{item.dateString}}">
            <text class="day-num">{{item.day}}</text>
            <view class="dots-row">
                <view class="dot pending" wx:if="{{item.pendingCount > 0}}"></view>
                <view class="dot completed" wx:if="{{item.completedCount > 0}}"></view>
            </view>
            <!-- 只有选中时才显示详细数字，避免界面太乱 -->
            <view class="stats-text" wx:if="{{item.dateString === selectedDate && (item.pendingCount > 0 || item.completedCount > 0)}}">
                {{item.completedCount}}/{{item.pendingCount + item.completedCount}}
            </view>
        </view>
    </view>
  </view>

  <!-- Task List -->
  <view class="task-list">
    <block wx:if="{{taskGroups.length > 0}}">
      <view class="task-group" wx:for="{{taskGroups}}" wx:key="title" wx:for-item="group">
        <!-- 分组标题 -->
        <view class="group-header flex-row align-center mb-20">
          <view class="group-dot {{group.color}}"></view>
          <text class="text-h3 mr-10">{{group.title}}</text>
          <text class="text-desc">({{group.list.length}})</text>
        </view>

        <!-- 任务卡片 -->
        <view class="task-card card flex-row" wx:for="{{group.list}}" wx:key="_id" bindlongpress="showActionSheet" data-task="{{item}}">
          <!-- 优先级条 -->
          <view class="priority-strip {{item.priority}}"></view>
          
          <view class="content flex-col">
            <view class="flex-row justify-between mb-10">
              <text class="text-h3">{{item.title}}</text>
              <view class="status-tag {{item.status}}" wx:if="{{item.status !== 'pending'}}">
                {{item.status === 'completed' ? '已完成' : (item.status === 'pending_approval' ? '待审核' : '已逾期')}}
              </view>
            </view>
            
            <view class="text-desc mb-20 line-clamp-2">{{item.desc || '暂无描述'}}</view>

            <!-- 证明图片预览 -->
            <view class="proofs-row mb-20" wx:if="{{item.proofs && item.proofs.length > 0}}">
                <image class="proof-img" wx:for="{{item.proofs}}" wx:for-item="url" wx:key="*this" src="{{url}}" mode="aspectFill" catchtap="previewProof" data-current="{{url}}" data-urls="{{item.proofs}}"></image>
            </view>
            
            <view class="footer flex-row justify-between align-center">
              <view class="flex-row align-center">
                <image class="avatar-sm mr-10" src="{{item.assignee_avatar || '../../images/user.png'}}"></image>
                <text class="text-desc mr-20">{{item.assignee_name}}</text>
                <text class="tag tag-primary">{{item.type}}</text>
              </view>
              
              <!-- 显式操作按钮 -->
              <view class="flex-row align-center">
                <text class="text-desc mr-20">{{item.deadlineStr}}</text>
                <view class="btn-sm btn-outline" 
                      wx:if="{{item.status === 'pending'}}" 
                      catchtap="onTapComplete" 
                      data-task="{{item}}"
                      style="font-size: 24rpx; padding: 6rpx 16rpx; border: 1px solid #1296db; color: #1296db; border-radius: 8rpx;">
                  完成
                </view>
                <view class="btn-sm btn-outline" 
                      wx:if="{{item.status === 'pending_approval' && userInfo.role === 'admin'}}" 
                      catchtap="onTapApprove" 
                      data-task="{{item}}"
                      style="font-size: 24rpx; padding: 6rpx 16rpx; border: 1px solid #07c160; color: #07c160; border-radius: 8rpx;">
                  审核
                </view>
              </view>
            </view>
          </view>
        </view>
      </view>
    </block>
    
    <!-- 空状态 -->
    <view class="empty-state flex-col align-center justify-center" wx:else>
      <image class="empty-img mb-30" src="../../images/task.png"></image>
      <text class="text-desc">这里空空如也，去发布新任务吧</text>
      <navigator url="/pages/task_create/index" open-type="switchTab" class="btn-primary mt-20" style="width: 200rpx; font-size: 28rpx; padding: 16rpx 0;">去发布</navigator>
    </view>
  </view>
</view>